(function($){$.fn.wylValidate=function(options,callback){var defaults={font:{size:"30px",family:"serif",txt:"拖动拼图完成验证",x:20,y:50},puzzle:{draw:{w:8,h:8,offset:4},make:{w:62,h:62}},cssUrl:"../static/common/plugin/slidevalidate/",bgImg:"../static/images/validate/test2.png",sbardata:{txt:"向右滑动滑块填充拼图"}};var wyl=this,opts=$.extend(defaults,options),canvasBox=null,wylValidateInit=function(){var canvas1=document.getElementById("canvas1");if(canvas1.getContext){var ctx1=canvas1.getContext("2d");getBase64(opts.bgImg,dataURL);loadBgImage({ctx:ctx1,canvas:canvas1,img:opts.bgImg},function(_bgImg){var _tx=newRandom(165),_ty=newRandom(10);var bg=new Image;bg.src=_bgImg;bg.onload=function(){bg.width=330;console.log(bg.width)};drawBgImage({ctx:ctx1,canvas:canvas1,img:_bgImg},function(res){})})}},drawBgImage=function(_data,callback){drawPuzzle({ctx:_data.ctx,isValid:false},function(res){if(callback){}})},drawValidateBar=function(_data,callback){$(canvasBox).append(createCanvas(3));var canvas3=document.getElementById("canvas3");var cxt3=canvas3.getContext("2d");canvas3.width=opts.puzzle.make.w;canvas3.height=opts.puzzle.make.h;_data.ctx.width=imgObj.width;_data.ctx.height=imgObj.height;_data.ctx.drawImage(imgObj,0,0,imgObj.width,imgObj.height);_data.ctx.globalCompositeOperation="destination-in";_data.ctx.translate(0,0);drawPuzzle({ctx:_data.ctx,isValid:true},function(res){var dataImg=_data.ctx.getImageData(res.x,res.y,canvas3.width,canvas3.height);cxt3.putImageData(dataImg,0,0,0,0,canvas3.width,canvas3.height);var _validBarImg=saveAsPng(canvas3);removeCanvas(canvas3);removeCanvas(_data.canvas)})},drawPuzzle=function(_data,callback){_data.ctx.save();_data.ctx.beginPath();_data.ctx.translate(0,0);var dx=opts.puzzle.draw.w;var dy=opts.puzzle.draw.h;var offset=opts.puzzle.draw.offset;_data.ctx.moveTo(dx,dy*2);_data.ctx.lineTo(dx,dy*3);_data.ctx.quadraticCurveTo(-offset,dy*4,dx,dy*5);_data.ctx.lineTo(dx,dy*6);_data.ctx.quadraticCurveTo(dx,dy*7,dx*3,dy*7);_data.ctx.lineTo(dx*3,dy*7);_data.ctx.quadraticCurveTo(dx*4,dy*6-offset,dx*5,dy*7);_data.ctx.lineTo(dx*6,dy*7);_data.ctx.quadraticCurveTo(dx*7,dy*7,dx*7,dy*6);_data.ctx.lineTo(dx*7,dy*5);_data.ctx.quadraticCurveTo(dx*6-offset,dy*4,dx*7,dy*3);_data.ctx.lineTo(dx*7,dy*2);_data.ctx.quadraticCurveTo(dx*7,dy,dx*6,dy);_data.ctx.lineTo(dx*5,dy);_data.ctx.quadraticCurveTo(dx*4,-offset,dx*3,dy);_data.ctx.lineTo(dx*2,dy);_data.ctx.quadraticCurveTo(dx,dy,dx,dy*2);_data.ctx.closePath();if(!_data.isValid){_data.ctx.fillStyle="rgba(0,0,0,0.5)";_data.ctx.shadowColor="rgba(255,255,255,1)";_data.ctx.shadowOffsetY=1;_data.ctx.shadowOffsetX=1;_data.ctx.shadowBlur=2}_data.ctx.fill();if(callback){callback({x:_data.x,y:_data.y,dx:dx,dy:dy,offset:offset})}},createCanvas=function(cls){var canvas=document.createElement("canvas");canvas.setAttribute("class","wyl_canvas canvas"+cls);canvas.setAttribute("id","canvas"+cls);return canvas},createImg=function(_url,cls){var html="<p class='wyl_validatebg "+cls+"' ><img id="+cls+" src="+_url+" /></p>";return html},newRandom=function(num){var random=0;return random},removeCanvas=function(canvas){canvas.parentNode.removeChild(canvas)},layoutHtml=function(){var html="<div class='wyl_validateBox'>"+"<div class='wyl_canvasBox'></div>"+"<div class='wyl_barBox'>"+"<p class='wp1 slideBar'></p>"+"<p class='wp2'>"+opts.sbardata.txt+"</p>"+"</div>"+"</div>";return html},getBase64=function(url,callback){var Img=new Image,dataURL="";Img.src=url;Img.onload=function(){var canvas=document.createElement("canvas"),width=Img.width,height=Img.height;canvas.width=width;canvas.height=height;canvas.getContext("2d").drawImage(Img,0,0,width,height);dataURL=canvas.toDataURL("image/jpeg");callback?callback(dataURL):null}};addLink=function(url,type){var hint=document.createElement("link");hint.setAttribute("rel",type);hint.setAttribute("href",url);document.getElementsByTagName("head")[0].appendChild(hint)},mx1,mx2,mx3,sx1,sx2,sx3,imgx1,imgx2,imgx3,barBoxW=330,barW=50;addLink(opts.cssUrl+"css/slidevalidate.css","stylesheet");return wyl.each(function(){$(this).append(layoutHtml());canvasBox=$(this).find(".wyl_canvasBox");$(canvasBox).append(createCanvas(1));wylValidateInit();$(".slideBar").mousedown(function(e){$(this).addClass("action");mx1=$(this).offset().left;$(".slideBar").mousemove(function(e){slideEvent(e)});$(document).mouseup(function(e){slideEvent(e);$(".slideBar").removeClass("action").unbind();$(document).unbind()}).mousemove(function(e){slideEvent(e)})})});function slideEvent(e){mx2=e.clientX;mx3=slideY(mx1,mx2);$(".slideBar").css({left:mx3-barW/2});$(".imgValid").css({left:mx3-barW/2})}function slideY(x1,x2){var x3=x2-x1;if(x3<barW/2){x3=barW/2}else if(x3>barBoxW-barW/2-2){x3=barBoxW-barW/2-2}return x3}}})(window.jQuery);