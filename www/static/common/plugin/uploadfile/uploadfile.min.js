(function($){$.fn.uploadFile=function(options,callback){var defaults={movieid:0,label:"选择上传",haslabel:"已经上传",type:"image",url:"/addfiles",loadFiles:"/loadfiles",cssUrl:"",multiple:"",curFiles:[],total:5,acceptImg:"image/gif,image/jpeg,image/png",acceptVideo:"video/mp4,video/mpeg"};var opts=$.extend(defaults,options),wylThis=this,deleteFile=function(){var currentObj=$(this).parent();var $fileid=$(this).parent().attr("fileid");console.log("fileid:"+$fileid);console.log(typeof $fileid);if($fileid!=""&&$fileid!="undefined"&&typeof($fileid*1)=="number"){$.post("/deletefile",{fileid:$fileid},function(res){if(res.data>0){opts.total++;checkTotal();$(currentObj).empty().remove()}else{console.log(res)}})}else{var _index=$(this).parent().index();$(currentObj).empty().remove();opts.curFiles=opts.curFiles.filter(function(el,index){if(index!=_index){return true}return false});filePathBox_empty(currentObj.parent())}},checkTotal=function(){if(opts.total==0){fullList()}else{unfullList()}},fullList=function(){$(wylThis).find(".upload_formBox").hide();$(wylThis).find(".file_selectBtn").unbind();$(wylThis).find(".fileSelect").unbind()},unfullList=function(){$(wylThis).find(".upload_formBox").show();$(wylThis).find(".file_selectBtn").unbind().bind("click",file_selectBtn);$(wylThis).find(".fileSelect").unbind();$(document).on("change",".fileSelect",fileSelect)},file_selectBtn=function(){var fileInp='<input type="file" name="imgfile" class="fileSelect upload_btn"  accept='+opts.accept+" "+opts.multiple+" >";$(this).siblings(".fileSelect").remove();$(this).after(fileInp);$(this).siblings(".fileSelect").unbind();$(this).siblings(".fileSelect").unbind().click()},fileSelect=function(){console.log(this.files);var files=this.files;var myFileArr=[];if(files&&files.length){Array.prototype.push.apply(myFileArr,files);var filePathBox=$(this).siblings(".filePathBox");addItem(filePathBox,myFileArr)}},addItem=function(filePathBox,files){filehtml="";opts.curFiles=[];for(var i=0;i<files.length;i++){if(i<=opts.total-1){opts.curFiles.push(files[i]);filehtml+=fileHtml(opts.curFiles[i].name,"upload_"+i);filePathBox.html(filehtml)}}filePathBox_empty(filePathBox);var file_uploadBtn=filePathBox.siblings(".file_uploadBtn");file_uploadBtn.unbind().click(function(){uploadFn(this)})},uploadFn=function(file_uploadBtn){for(var i in opts.curFiles){if(opts.movieid==0){console.log("电影ID不存在");return false}var formData=new FormData;formData.append("movieid",opts.movieid);formData.append("myFileTest"+i,opts.curFiles[i]);$.ajax({url:opts.url,type:"POST",cache:false,async:false,data:formData,processData:false,contentType:false,xhr:function(){var myXhr=$.ajaxSettings.xhr();if(myXhr.upload){myXhr.upload.addEventListener("progress",progressHandlingFunction,false)}return myXhr},success:function(res){console.log(res);if(res.data.length){var filehtml="";filehtml=fileHtml(res.data[0].name,"hasUpload",res.data[0].id);$(wylThis).children(".uploadResult").children(".resultBox").find(".filePathBox").append(filehtml);$(file_uploadBtn).siblings(".filePathBox").find(".file_path_panel").eq(0).remove();opts.total--;checkTotal()}else{console.log("返回错误:"+res.data.message)}},error:function(XMLHttpRequest,textStatus,errorThrown){console.log(XMLHttpRequest.readyState)}});function progressHandlingFunction(e){if(e.lengthComputable){var percent=e.loaded/e.total*100+"%";$(".upload_"+i).children(".file_path_bg").width(percent)}}}},loadPopList=function(){$.ajax({url:opts.loadFiles,type:"POST",cache:false,data:{movieid:opts.movieid},async:false,success:function(res){opts.total=res.data.total-res.data.list.length;if(res.data.list.length>0){for(var i=0;i<res.data.list.length;i++){if(i>4)return;var filehtml="";filehtml=fileHtml(res.data.list[i].name,"hasUpload",res.data.list[i].id);$(wylThis).children(".uploadResult").children(".resultBox").find(".filePathBox").append(filehtml)}}else{return false}}})},uploadHtml=function(){var html='<form enctype="multipart/form-data" method="post" name="uploadForm">'+'<div class="upload_formBox">'+'<p class="p1">'+opts.label+":</p>"+'<div class="upload_inpBox uploadBox ">'+'<div class="filePathBox"></div>'+'<input type="file" name="imgfile" class="fileSelect upload_btn" accept='+opts.accept+" "+opts.multiple+" />"+'<input type="button" class="file_selectBtn upload_btn" value="请选择..." />'+'<input type="button" class="file_uploadBtn upload_btn" value="开始上传" />'+'<div class="uploadProgress"><p class="pop"></p></div>'+'<a class="file_closeBtn" href="javascript:void(null)">X</a>'+"</div>"+'<p class="p3">*</p>'+"</div>"+"</form>"+'<div class="uploadResult">'+'<p class="p1">'+opts.haslabel+":</p>"+'<div class="resultBox">'+'<div class="filePathBox "></div>'+'<a class="file_closeBtn" href="javascript:void(null)">X</a>'+"</div>"+'<p class="p3"></p>'+"</div>";return html},fileHtml=function($name,cls,$fileid){var html='<div class="file_path_panel '+cls+'"  fileid='+$fileid+" >"+'<p class="file_txt">'+$name+"</p>"+'<a class="file_delete" href="javascript:void(null)">X</a>'+'<div class="file_path_bg"></div>'+"</div>";return html},filePathBox_empty=function(){if($(wylThis).find(".filePathBox").html()){$(wylThis).find(".file_selectBtn").val("重新选择");$(wylThis).find(".file_uploadBtn").addClass("cls_show")}else{$(wylThis).find(".file_selectBtn").val("请选择...");$(wylThis).find(".file_uploadBtn").removeClass("cls_show")}},addLink=function(url,type){var hint=document.createElement("link");hint.setAttribute("rel",type);hint.setAttribute("href",url);document.getElementsByTagName("head")[0].appendChild(hint)};addLink(opts.cssUrl+"css/uploadfile.css","stylesheet");return this.each(function(){opts.accept=opts.type=="image"?"image/gif,image/jpeg,image/png":"video/mp4,video/mpeg";$(wylThis).append(uploadHtml());if(!opts.movieid||typeof(opts.movieid*1)!="number"){console.log("error:无效ID");return false}else{loadPopList()}checkTotal();$(document).on("click",".file_delete",deleteFile)})}})(window.jQuery);